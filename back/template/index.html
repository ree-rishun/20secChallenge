<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>絵を描く | #20秒チャレンジ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SNS -->
    <meta name="twitter:site" content="@reerishun">
    <meta name="twitter:text:title" content="#20秒チャレンジ">
    <meta name="twitter:image" content="">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@reerishun">
    <meta property="og:title" content="#20秒チャレンジ" />
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:site_name" content="#20秒チャレンジ">
    <meta property="og:description" content="20秒で絵を描き上げよう！">
    <meta property="og:image" content="">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="../static/style/reset.css">
    <link rel="stylesheet" type="text/css" href="../static/style/main.css">

    <!-- JS -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
</head>
<body>
<input
    id="draw-title"
    type="text"
    name="title"
    placeholder="お題を入力">

<div>
    <canvas id="draw-area" width="375px" height="375px"></canvas>
    <div id="draw-readonly">
        <button
                id="start-button"
                type="button"
                onclick="cntStart()">
            START
        </button>
    </div>
    <div id="draw-result">
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-hashtags="20秒チャレンジ" data-show-count="false">ツイートする</a>
    </div>
</div>

<div id="timer-area">
    <img src="../static/img/timer.png" alt="timer">
    <span id="timer">3</span>
</div>
<button id="clear-button" style="cursor: pointer">全消し</button>

<script src="../static/js/index.js"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script>
    let cvs = document.getElementById("draw-area");
    const xhr = new XMLHttpRequest();

    const limit = 30;    // 制限時間の宣言

    let timer; //タイマーを格納する変数（タイマーID）の宣言
    let count = 0;

    //カウントダウン関数を1000ミリ秒毎に呼び出す関数
    document.getElementById("start-button").onclick = function () {
        // タイマー開始
        timer = setInterval(
            "countDown()",
            1000
        );

        // カウント開始時のみ書き込み可能に
        document.getElementById("draw-readonly").style.display ="none";
        document.getElementById("draw-area").style.display ="inline-block";
    }

    function countUp () {
        console.log(count++);
    }

    //カウントダウン関数
    function countDown() {
        document.getElementById('timer').innerText--;

        if (document.getElementById('timer').innerText === "0") {
            clearInterval(timer);
            document.getElementById("draw-area").style.display ="none";
            document.getElementById("draw-result").style.display ="inline-block";
        }
    }

    //残り時間を書き出す関数
    function tmWrite(int) {
        int = parseInt(int);

        if (int <= 0) {
            reSet();

            //canvasデータを画像に変換にする関数
            console.log(cvs);

            // 画像を保存
            saveImage(cvs.toDataURL("image/png"));
        } else {
            //残り秒数はintを60で割った余り
            document.timer.elements[1].value = int % 60;
        }
    }

    function saveImage (image) {

        xhr.open('POST', 'http://localhost:8000/save');
        xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
        // フォームに入力した値をリクエストとして設定
        let base64Data = image.split(',')[1];

        xhr.onreadystatechange = function() { // 状態が変化すると関数が呼び出されます。
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                // ここに画像のリンクが来る
                console.log(this.responseText)
            }
        }

        xhr.send('title=' + document.getElementsByName('title')[0].value + '&file=' + base64Data);
    }

    //フォームを初期状態に戻す（リセット）関数
    function reSet() {
        document.timer.elements[0].value = "0";
        document.timer.elements[1].value = limit;
        document.timer.elements[2].disabled = false;
        clearInterval(timer1);
    }

</script>

</body>
</html>